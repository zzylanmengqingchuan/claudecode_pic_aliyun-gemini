# 🔍 Gemini API 网络问题 - 完整诊断

## 问题现状

**错误**: `ETIMEDOUT` - 连接到 `generativelanguage.googleapis.com:443` 超时

根据 Google Gemini API 官方故障排查文档和社区反馈：

### 核心原因

你遇到的是**网络连接问题**，在中国大陆访问 Google API 时常见。

---

## 🎯 根本问题

### 为什么 VPN 不生效？

1. **Dove VPN 只对浏览器生效**
   - 浏览器可以访问 Google
   - 但 Node.js 进程无法使用 VPN

2. **Node.js 不会自动使用系统代理**
   - 必须通过环境变量明确告诉 Node.js 使用代理
   - 这就是为什么需要 `start-dove.bat`

### 当前问题

你使用 `npm start` 启动，**没有配置代理环境变量**，所以：
- ❌ Node.js 直接连接 Google API（被墙）
- ❌ 连接超时（ETIMEDOUT）
- ✅ 需要：通过 Dove VPN 的本地代理（端口3100）

---

## ✅ 正确的解决方案

### 方案 1：使用 start-dove.bat（推荐）

**这是唯一正确的启动方式！**

```batch
# 这个脚本会：
1. 设置环境变量: HTTP_PROXY=http://127.0.0.1:3100
2. 设置环境变量: HTTPS_PROXY=http://127.0.0.1:3100
3. 启动 Node.js 服务器
```

#### 立即执行：

1. **停止所有旧服务器**
2. **确保 Dove VPN 已连接**（美国节点）
3. **双击运行 `start-dove.bat`**
4. **不要**用 `npm start`

### 方案 2：手动设置环境变量

如果批处理文件不work，在命令提示符中：

```cmd
set HTTP_PROXY=http://127.0.0.1:3100
set HTTPS_PROXY=http://127.0.0.1:3100
npm start
```

**注意**：必须在**同一个**命令提示符窗口中设置并启动！

---

## 🔍 故障排查步骤

### 步骤 1：验证 Dove VPN 工作

在浏览器访问：
```
https://www.google.com
```

✅ 能访问 → Dove VPN 工作正常
❌ 不能访问 → 检查 VPN 连接

### 步骤 2：测试代理端口

在命令提示符运行：
```cmd
curl --proxy http://127.0.0.1:3100 https://www.google.com
```

✅ 返回 HTML → 代理工作正常
❌ 超时/错误 → 检查 Dove 设置中的端口号

### 步骤 3：使用正确的启动方式

**必须**使用 `start-dove.bat`，不能用 `npm start`

---

## ❌ 常见错误

### 错误 1：直接运行 npm start
```cmd
npm start  ← 错误！没有代理配置
```

**结果**：ETIMEDOUT（你当前的问题）

### 错误 2：在不同窗口设置环境变量
```cmd
# 窗口 1
set HTTP_PROXY=http://127.0.0.1:3100

# 窗口 2
npm start  ← 错误！环境变量不生效
```

### 错误 3：VPN 未连接就启动
```cmd
start-dove.bat  ← 但 Dove VPN 没有连接
```

**结果**：代理检测失败

---

## ✅ 正确的完整流程

### 1. 启动并连接 Dove VPN
- 打开 Dove
- 选择美国节点
- 点击"连接"
- 等待显示"已连接"

### 2. 验证 VPN（可选）
在浏览器访问：`https://www.google.com`

### 3. 使用专用脚本启动
**双击 `start-dove.bat`**

### 4. 检查启动日志
应该看到：
```
✓ Dove VPN 连接正常
✓ 代理已配置: http://127.0.0.1:3100

专业头像生成器服务已启动
服务地址: http://localhost:3000
```

### 5. 测试生成功能
- 打开 `http://localhost:3000`
- 上传照片
- 选择风格
- 生成头像

### 6. 成功标志
服务器日志显示：
```
收到生成头像请求
调用 Gemini API...
API 响应状态码: 200  ← 成功！
图片生成成功
```

**不再是** `ETIMEDOUT`

---

## 🚨 重要提示

### 为什么这么复杂？

Google Gemini API 在中国大陆：
1. 直接访问被墙 → 需要 VPN
2. VPN 只对浏览器生效 → 需要配置代理
3. Node.js 不自动使用代理 → 需要环境变量
4. 环境变量要正确设置 → 需要专用脚本

### 关键点

- ✅ Dove VPN 必须连接
- ✅ 必须使用 `start-dove.bat`
- ✅ 不能用 `npm start`
- ✅ 端口必须是 3100（Dove 的本地端口）

---

## 🔧 如果还是不行

### 检查清单：

1. [ ] Dove VPN 已启动并连接
2. [ ] 能在浏览器访问 google.com
3. [ ] Dove 本地端口是 3100
4. [ ] 使用 `start-dove.bat` 启动（不是 npm start）
5. [ ] 没有其他进程占用 3000 端口
6. [ ] 启动脚本显示"Dove VPN 连接正常"

### 如果代理检测失败

可能原因：
1. Dove VPN 未连接
2. 端口号不是 3100（检查 Dove 设置）
3. Dove 未开启"允许来自局域网的连接"

---

## 📋 下一步

1. **停止所有旧服务器**
2. **确保 Dove VPN 已连接**
3. **双击 `start-dove.bat`**
4. **查看是否显示"Dove VPN 连接正常"**
5. **告诉我结果**

如果还是失败，告诉我 `start-dove.bat` 显示的具体错误信息。
