# VPN 配置和使用说明

## 🔧 使用 VPN 访问 Google Gemini API

### 步骤 1：确保 VPN 正常工作

1. **连接 VPN（美国节点）**
   - 确保 VPN 已成功连接
   - 节点选择：美国（推荐）

2. **验证 VPN 连接**

   在浏览器中访问以下网站测试：
   ```
   https://www.google.com
   ```

   如果能正常打开 Google，说明 VPN 工作正常。

3. **测试 API 连通性**

   在浏览器中访问：
   ```
   https://generativelanguage.googleapis.com
   ```

   应该返回 404 错误（这是正常的，说明能连接到服务器）

### 步骤 2：配置系统代理（重要！）

⚠️ **关键步骤**：确保 VPN 的代理设置对 Node.js 生效

#### 方法 A：全局系统代理

1. 确保 VPN 软件开启了"系统代理"选项
2. 在 VPN 设置中找到并启用：
   - ✅ "接管系统代理"
   - ✅ "全局代理模式"
   - ✅ "代理所有流量"

#### 方法 B：手动设置环境变量

如果 VPN 提供 HTTP 代理端口（通常是 1080, 7890 等），在 `.env` 文件中添加：

```env
# 你的 VPN HTTP 代理地址
HTTP_PROXY=http://127.0.0.1:7890
HTTPS_PROXY=http://127.0.0.1:7890
```

**常见 VPN 代理端口：**
- Clash: `http://127.0.0.1:7890`
- V2Ray: `http://127.0.0.1:10809`
- Shadowsocks: `http://127.0.0.1:1080`

### 步骤 3：重启服务器

配置好代理后，必须重启 Node.js 服务器：

```bash
# 1. 停止当前服务器（按 Ctrl+C）
# 2. 重新启动
npm start
```

### 步骤 4：测试图片生成

1. 打开浏览器访问：`http://localhost:3000`
2. 上传照片
3. 选择风格
4. 点击"生成专业头像"
5. 等待生成（首次可能需要 20-30 秒）

---

## 🔍 故障排查

### 问题 1：仍然连接超时

**检查清单：**
- [ ] VPN 已连接并正常工作
- [ ] 能在浏览器打开 google.com
- [ ] VPN 开启了"系统代理"模式
- [ ] 已重启 Node.js 服务器
- [ ] 检查 VPN 软件是否有"仅浏览器"模式（需要关闭）

### 问题 2：代理端口不确定

**查找 VPN 代理端口：**

1. 打开 VPN 软件设置
2. 查找"端口设置"或"代理设置"
3. 常见位置：
   - Clash: 设置 → 端口（通常 7890）
   - V2Ray: 偏好设置 → HTTP 代理端口
   - Shadowsocks: 服务器 → 本地端口

### 问题 3：环境变量不生效

**Windows 系统：**

1. 打开 PowerShell（管理员）
2. 设置临时环境变量：
   ```powershell
   $env:HTTP_PROXY="http://127.0.0.1:7890"
   $env:HTTPS_PROXY="http://127.0.0.1:7890"
   ```
3. 在同一个 PowerShell 窗口运行：
   ```powershell
   npm start
   ```

---

## 💡 推荐方案

### 最简单的方法：

1. **使用 Clash 或类似 VPN**
   - 开启"系统代理"模式
   - 选择"全局模式"（而非规则模式）

2. **验证代理生效**
   - 在命令行运行：
     ```bash
     curl https://www.google.com
     ```
   - 如果能返回内容，说明代理生效

3. **重启服务器**
   ```bash
   npm start
   ```

---

## ⚙️ 高级配置：修改代码支持代理

如果上述方法都不行，我可以修改代码直接集成代理支持。

需要你提供：
- VPN 的 HTTP 代理地址（如：`127.0.0.1`）
- 代理端口（如：`7890`）

---

## 📞 需要帮助？

如果遇到问题，请告诉我：

1. 你使用的 VPN 软件名称（Clash/V2Ray/其他）
2. VPN 是否能让浏览器正常访问 Google
3. VPN 软件中的代理端口号

我可以根据你的具体情况提供更详细的配置方案。

---

## ✅ 成功标志

当配置正确后，服务器日志应该显示：

```
收到生成头像请求
处理图片: upload-xxxxx.jpg, 风格: creative
调用 Gemini API...
准备调用 Gemini 2.5 Flash Image 模型...
发送 HTTPS 请求到 Gemini API...
API 响应状态码: 200  ← 这里应该是 200
成功解析 API 响应
成功提取生成的图片
图片生成成功
```

而不是 `ETIMEDOUT` 错误。
